<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.2//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.penske.apps.adminconsole.dao.LoadsheetManagementDao">


    <!-- To get Component rules in loadsheet management page -->
  	<select id="getLoadsheetComponents" resultType="com.penske.apps.adminconsole.model.ComponentVisibilityModel"> 
		SELECT 	SCV.CMP_VISIBLE_ID AS componentVisibilityId,
		SCV.CAT_TYPE_ID AS categoryId,
		SCV.COMPONENT_ID AS componentId,
		VCS.COMPONENT_GROUP AS group,
		VCS.SUB_GROUP AS subGroup,
		VCS.SUB_COMPONENT_NAME AS componentName,
		SCV.V2B_VISIBILITY AS screen2b,
		SCV.LOADSHEET_VISIBILITY AS lsOverride,
		(SELECT COUNT(SCRO.RULE_ID) FROM SMC_COMPONENT_RULE_OVERRIDES SCRO WHERE SCRO.CMP_VISIBLE_ID = SCV.CMP_VISIBLE_ID) AS ruleCount
		FROM SMC_COMPONENT_VISIBILITY SCV
		JOIN corp.VEHCMPSGF VCS on SCV.COMPONENT_ID=VCS.COMPONENT_ID WHERE SCV.CAT_TYPE_ID=#{categoryId}  
 		
 	</select>
 	
 	<!-- To Load the Details in Load Sheet Management Page-->
	<select  id="getLoadsheetManagementDetails" resultType="com.penske.apps.adminconsole.model.LoadsheetManagement">
		SELECT 	CAT_TYPE_ID						AS  catTypeId,
				PO_CATEGORY 					AS 	category,
				TYPE       						AS	type,
				USES_DEFAULT  					AS	usesDefault,
				FIRST_NAME||' '||LAST_NAME		AS 	editedBy,
				CTM.MODIFIED_DATE				AS	editedDate
		FROM
				SMC_CAT_TYPE_MASTER CTM
		LEFT JOIN 
				SMC_USER_MASTER SUM 
		ON 		SUM.SSO=CTM.MODIFIED_BY
	</select>
	
	<!-- To Load the Details in Load Sheet Management Page-->
	<select  id="getLoadsheetRules" resultType="com.penske.apps.adminconsole.model.RuleMaster">
		SELECT 	CVRM.RULE_ID							AS 	ruleId,
				NAME       								AS	ruleName,
				DESCRIPTION								AS	description,
				COUNT(CRO.RULE_ID)						AS	timesUsed,
				SUMC.FIRST_NAME||' '||SUMC.LAST_NAME	AS 	createdBy,
				CVRM.CREATED_DATE						AS	createdDate,
				SUME.FIRST_NAME||' '||SUME.LAST_NAME	AS 	editBy,
				CVRM.MODIFIED_DATE						AS	editDate
		FROM
				SMC_CMP_VISIBILITY_RULES_MASTER CVRM
		LEFT JOIN 
				SMC_USER_MASTER SUMC
		ON 		SUMC.SSO=CVRM.CREATED_BY 	 
		LEFT JOIN 
				SMC_USER_MASTER SUME
		ON		SUME.SSO=CVRM.MODIFIED_BY
		LEFT JOIN
				SMC_COMPONENT_RULE_OVERRIDES CRO
		ON		CVRM.RULE_ID = CRO.RULE_ID
		GROUP BY
				CVRM.RULE_ID,NAME,DESCRIPTION,SUMC.FIRST_NAME||' '||SUMC.LAST_NAME,CVRM.CREATED_DATE,SUME.FIRST_NAME||' '||SUME.LAST_NAME,CVRM.MODIFIED_DATE
	</select>
	
	<!-- To Insert the Rule master Details -->
 	<insert id="insertRuleMasterDetails" useGeneratedKeys="true" keyProperty="rule.ruleId" keyColumn="RULE_ID" >
 		INSERT INTO 
 					SMC_CMP_VISIBILITY_RULES_MASTER 
 					(NAME,			DESCRIPTION,			CREATED_BY,			MODIFIED_BY)
 		VALUES 		(#{rule.ruleName},	#{rule.description},	#{user.userSSO},	#{user.userSSO})
 	</insert>
 	
 	<!-- To insert the rule definition -->
 	<insert id="insertRuleDefinitions">
 		INSERT INTO 
 					SMC_CMP_VISIBILITY_RULES_DEFINITION
 					(RULE_ID,			CRITERIA_GROUP,				COMPONENT_ID,			COMPONENT_TYPE,
 					 OPERAND,			COMPONENT_VALUE,			CREATED_BY,				MODIFIED_BY)
 		VALUES		
 			 <foreach item="ruleDef" collection="ruleDefList" separator=",">
			 		(#{ruleDef.ruleId},	#{ruleDef.criteriaGroup},	#{ruleDef.componentId},	#{ruleDef.componentType},
 					 #{ruleDef.operand},#{ruleDef.value},			#{user.userSSO},	#{user.userSSO})
 			 </foreach>
 	</insert>
 	
 	<!-- To Update the rule master details -->
 	<update id="updateRuleMasterDetails">
 		UPDATE
 				SMC_CMP_VISIBILITY_RULES_MASTER
 		<set>		
 				NAME			=	#{rule.ruleName},
 				DESCRIPTION		=	#{rule.description},
 				MODIFIED_BY		=	#{user.userSSO},
 				MODIFIED_DATE	=	CURRENT_TIMESTAMP
 		</set>
 		WHERE
 				RULE_ID		=	#{rule.ruleId}
 				
 	</update>
 	<!-- To update rule definition details -->
 	<update id="updateRuleDefinitions">
 		
		 	UPDATE
		 			SMC_CMP_VISIBILITY_RULES_DEFINITION
		 	<set>		
		 			CRITERIA_GROUP	=	#{ruleDef.criteriaGroup},
		 			COMPONENT_ID	=	#{ruleDef.componentId},
		 			COMPONENT_TYPE	=	#{ruleDef.componentType},
		 			OPERAND			=	#{ruleDef.operand},
		 			COMPONENT_VALUE	=	#{ruleDef.value},
		 			MODIFIED_BY		=	#{user.userSSO},
		 			MODIFIED_DATE	=	CURRENT_TIMESTAMP
		 	</set>
		 	WHERE	
		 			RULE_DEF_ID		=	#{ruleDef.ruleDefId}
		 	AND 	
		 			RULE_ID			=	#{ruleDef.ruleId}
	 	
 	</update>
 	
 	<!-- Delete Rule Definition details -->
 	<delete id="deleteRuleDefinitions">
 		DELETE
 		FROM
 				SMC_CMP_VISIBILITY_RULES_DEFINITION
 		WHERE
 				RULE_DEF_ID IN 
 				<foreach item="ruleDefId"  collection="ruleDefIdList" open="(" separator="," close=")">
 					#{ruleDefId}
 				</foreach>
 				
 	</delete>
 	
 	<!-- Delete Rule details in rule master -->
 	<delete id="deleteRuleMasterDetails">
 		DELETE
 		FROM
 				SMC_CMP_VISIBILITY_RULES_MASTER
 		WHERE
 				RULE_ID =	#{ruleId} 
 	</delete>
 	<!-- Delete rule def details asscoiated to deleted ruleid -->
 	<delete id="deleteRuleDefDetails">
 		DELETE
 		FROM
 				SMC_CMP_VISIBILITY_RULES_DEFINITION
 		WHERE
 				RULE_ID =	#{ruleId} 
 	</delete>
 	
 	
 	<!-- Query to fetch the rule definition details based on ruleID -->
 	<select id="getRuleDetails" resultMap="ruleDetailsMap" >
 		SELECT 
 				TRIM(RULE_ID) AS RULE_ID,
 				TRIM(NAME) AS NAME, 
 				DESCRIPTION 
 		FROM 
 		 		SMC_CMP_VISIBILITY_RULES_MASTER 
 		 WHERE 	
 		 		RULE_ID=#{ruleId}
 	</select>
 	
 	
 	<resultMap id="ruleDetailsMap" type="com.penske.apps.adminconsole.model.RuleMaster">
		 <id property="ruleId" column="RULE_ID" />
		 <result property="ruleName" column="NAME" />
		 <result property="description" column="DESCRIPTION" />
		 <collection property="ruleDefinitionsList" column="RULE_ID" ofType="com.penske.apps.adminconsole.model.RuleDefinitions" javaType="ArrayList" select="getRuleDefDetails"/> 
	 </resultMap>
	 
	 <select id="getRuleDefDetails" parameterType="int" resultMap="ruleDefMap">
	
		SELECT  
				RULE_DEF_ID,
				CRITERIA_GROUP,
				COMPONENT_TYPE,
				COMPONENT_ID,
				OPERAND,
				COMPONENT_VALUE
		FROM
				SMC_CMP_VISIBILITY_RULES_DEFINITION
		WHERE 
				RULE_ID=#{ruleId}
	</select>
	 
	  <resultMap id="ruleDefMap" type="com.penske.apps.adminconsole.model.RuleDefinitions">
	 	<id property="ruleId" column="RULE_ID" />
	 	<result property="ruleDefId" column="RULE_DEF_ID" />
	 	<result property="criteriaGroup" column="CRITERIA_GROUP" />
	 	<result property="componentType" column="COMPONENT_TYPE" />
	 	<result property="componentId" column="COMPONENT_ID" />
	 	<result property="operand" column="OPERAND" />
	 	<result property="value" column="COMPONENT_VALUE" />
	 </resultMap>
	
	
	<!-- To get load sheet sequences -->
  	<select id="getLoadsheetSequences" resultType="com.penske.apps.adminconsole.model.LoadsheetSequence"> 
		SELECT
			SEQ_MASTER_ID AS id,
			NAME AS name,
			DESCRIPTION AS description,
			PO_CATEGORY AS category,
			TYPE AS type,
			LSM.OEM AS oem,
			FIRST_NAME||' '||LAST_NAME AS editedBy,
			LSM.MODIFIED_DATE AS editedDate
		FROM SMC_LOADSHEET_SEQ_MASTER LSM
		JOIN SMC_USER_MASTER SUM ON LSM.MODIFIED_BY=SUM.SSO 
		WHERE LSM.PO_CATEGORY=#{category} AND LSM.TYPE=#{type}
 	</select> 
 	
 	<!-- To get load sheet sequences from navigation link -->
  	<select id="getLoadsheetSequence" resultType="com.penske.apps.adminconsole.model.LoadsheetSequence"> 
		SELECT
			SEQ_MASTER_ID AS id,
			NAME AS name,
			DESCRIPTION AS description,
			PO_CATEGORY AS category,
			TYPE AS type,
			LSM.OEM AS oem,
			FIRST_NAME||' '||LAST_NAME AS editedBy,
			LSM.MODIFIED_DATE AS editedDate
		FROM SMC_LOADSHEET_SEQ_MASTER LSM
		JOIN SMC_USER_MASTER SUM ON LSM.MODIFIED_BY=SUM.SSO 
 	</select> 
 	
	<!-- TO get component rules-->
	<select  id="getComponentRules" resultType="com.penske.apps.adminconsole.model.RuleMaster">
		SELECT 	DISTINCT CVRM.RULE_ID AS 	ruleId,
		        CVRM.NAME   AS	ruleName
		FROM SMC_CMP_VISIBILITY_RULES_MASTER CVRM
		JOIN SMC_CMP_VISIBILITY_RULES_DEFINITION CVRD ON CVRM.RULE_ID=CVRD.RULE_ID
		WHERE CVRD.COMPONENT_ID=#{componetId}
	</select>
	
	<!-- TO get component visibility rules-->
	<select  id="getComponentVisibilityRules" resultType="com.penske.apps.adminconsole.model.ConfigureRule">
		SELECT 	RULE_ID AS 	ruleId,
				PRIORITY  AS priority,          
                VISIBILITY_OVERRIDE AS lsOverride
		FROM SMC_COMPONENT_RULE_OVERRIDES
		WHERE CMP_VISIBLE_ID=#{componentVisibleId} ORDER BY PRIORITY
	</select>
	
	<!-- To delete the rules associated to the component -->
    <delete  id="deleteComponentVisibilityRules">
 		DELETE FROM SMC_COMPONENT_RULE_OVERRIDES WHERE CMP_VISIBLE_ID=#{componentVisibilityId}
 	</delete>
 	
 	<!-- To associate list of rules to the component -->
 	<insert id="saveComponentVisibilityRules">
		INSERT INTO SMC_COMPONENT_RULE_OVERRIDES (CMP_VISIBLE_ID,RULE_ID, PRIORITY,VISIBILITY_OVERRIDE,CREATED_BY,
		CREATED_DATE, MODIFIED_BY, MODIFIED_DATE) VALUES
		<foreach collection="rule" item="item" separator=",">
		(#{componentVisibilityId},#{item.ruleId},#{item.priority},#{item.lsOverride},#{createdBy},current timestamp,#{createdBy},current timestamp)
		 </foreach>
    </insert>
    
 	<!-- To get the list of components for dropwdown in create rules -->
	<select id="getComponents" resultType="com.penske.apps.adminconsole.model.LoadSheetComponentDetails">
		SELECT 	COMPONENT_ID 				AS componentId,
				COMPONENT_TYPE				AS componentType,
				TRIM(COMPONENt_GROUP)		AS componentGroup,
				TRIM(SUB_GROUP)				AS subGroup,
				TRIM(SUB_COMPONENT_NAME) 	AS componentName
		FROM
				CORP.VEHCMPSGF 
	</select>
 	
 	<!-- To get Loadsheet Category Assigned for the rule -->
 	<select id="getAssignedLoadsheetCategories" resultType="com.penske.apps.adminconsole.model.LoadsheetManagement" >
 		SELECT
				CTM.PO_CATEGORY			AS 	category,
				CTM.TYPE				AS 	type,
				VCS.COMPONENT_GROUP		AS 	componentGroup,
				VCS.SUB_GROUP			AS	subGroup,
				VCS.SUB_COMPONENT_NAME	AS 	component
		FROM 
				SMC_COMPONENT_VISIBILITY SCV
		JOIN 	
				SMC_COMPONENT_RULE_OVERRIDES CRO
		ON	
				CRO.CMP_VISIBLE_ID = SCV.CMP_VISIBLE_ID
		JOIN 	
				CORP.VEHCMPSGF VCS 
		ON 
				SCV.COMPONENT_ID=VCS.COMPONENT_ID 
		JOIN 
				SMC.SMC_CAT_TYPE_MASTER CTM 
		ON 
				CTM.CAT_TYPE_ID = SCV.CAT_TYPE_ID
		
		WHERE 
				RULE_ID=#{ruleId}
 		
 	</select>
</mapper>